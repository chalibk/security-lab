name: Falco experiment - detect /etc/shadow access

on:
  workflow_dispatch:

jobs:
  test-falco:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify custom rule file
      run: |
        echo "Checking for custom rule..."
        ls -l $GITHUB_WORKSPACE/falco-rules/custom_sensitive.yml || exit 1

    - name: Start Falco (live mode)
      uses: falcosecurity/falco-actions/start@main
      with:
        mode: live
        falco-version: 'latest'
        verbose: true
        custom-rule-file: '${{ github.workspace }}/falco-rules/custom_sensitive.yml'

    - name: Run benign control step
      run: |
        echo "Running harmless commands"
        uname -a

    - name: Run test container that reads /etc/shadow
      run: |
        echo "Triggering Falco rule by reading /etc/shadow"
        docker run --rm ubuntu:22.04 bash -lc "sleep 1; cat /etc/shadow || true"

    - name: Wait for Falco to capture alerts
      run: |
        echo "Waiting 20 seconds for Falco to process events..."
        sleep 20

    - name: Inspect Falco container logs
      run: |
        echo "Checking Falco runtime logs..."
        docker logs falco || echo "No logs from Falco container."

    - name: Display Falco alert log (if present)
      run: |
        echo "Displaying Falco event log..."
        if [[ -s /tmp/falco_events.json ]]; then
          cat /tmp/falco_events.json
        else
          echo "⚠️ No Falco events recorded (file missing or empty)."
        fi

    - name: Stop Falco (live mode)
      uses: falcosecurity/falco-actions/stop@main
      with:
        mode: live
        verbose: true

    - name: Upload Falco events log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: falco-events
        path: /tmp/falco_events.json
        if-no-files-found: warn
