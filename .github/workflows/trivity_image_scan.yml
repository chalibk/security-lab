name: Trivy NGINX Image Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  nginx-trivy-scan:
    name: Scan NGINX Image with Trivy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.55.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.55.0_Linux-64bit.deb

      - name: Pull NGINX Image
        run: |
          echo "ðŸ›³ï¸ Pulling NGINX image..."
          docker pull nginx:latest

      - name: Run Trivy Scan on NGINX Image
        run: |
          echo "ðŸ” Scanning nginx:latest for vulnerabilities..."
          mkdir -p trivy-results
          trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            --format table \
            -o trivy-results/nginx-scan.txt \
            nginx:latest
          cat trivy-results/nginx-scan.txt

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-nginx-scan-report
          path: trivy-results/nginx-scan.txt

      - name: Fail if HIGH or CRITICAL vulnerabilities found
        run: |
          if grep -qE "CRITICAL|HIGH" trivy-results/nginx-scan.txt; then
            echo "âŒ High or Critical vulnerabilities detected in nginx:latest!"
            exit 1
          else
            echo "âœ… NGINX image is clean (no high/critical issues)."
          fi

      - name: Generate Trivy Status Badge
        if: always()
        run: |
          mkdir -p badges
          if grep -qE "CRITICAL|HIGH" trivy-results/nginx-scan.txt; then
            echo "![Trivy Scan](https://img.shields.io/badge/NGINX%20Scan-Failed-red)" > badges/trivy-badge.md
          else
            echo "![Trivy Scan](https://img.shields.io/badge/NGINX%20Scan-Passed-brightgreen)" > badges/trivy-badge.md
          fi

      - name: Upload Badge Markdown
        uses: actions/upload-artifact@v4
        with:
          name: trivy-badge
          path: badges/trivy-badge.md

